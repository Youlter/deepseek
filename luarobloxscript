--[[
    Youlter_GPT Framework - Total Overhaul
    Game: [INSERT GAME NAME]
    Design: Modern Dark Stealth (Electric Mint)
    Features: Interactive GUI (ScreenGui), Tween animations, Click handling, FPS-optimized ESP & FOV
    Architecture: Functional modules (UI_Library, Visuals, Combat, Settings)
]]

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local GuiService = game:GetService("GuiService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Ensure Drawing exists (for ESP/FOV)
local Drawing = Drawing or nil
if not Drawing then
    warn("Drawing library not available â€“ ESP and FOV disabled.")
end

-- ============================================
-- Settings Module
-- ============================================
local Settings = {
    Combat = {
        pSilentEnabled = false,
        pSilentKey = Enum.KeyCode.Q,
        FOV = 90,
        Hitbox = "Head",
        ShowFOV = true,
        FOVColor = Color3.fromRGB(0, 255, 136), -- Electric Mint
    },
    Visuals = {
        BoxESP = true,
        BoxColor = Color3.fromRGB(255, 255, 255),
        BoxThickness = 1,
        Tracer = true,
        TracerColor = Color3.fromRGB(0, 255, 136),
        HealthBar = true,
        Skeleton = false,
        SkeletonColor = Color3.fromRGB(255, 255, 255),
    },
    Misc = {
        SafeMode = false,
    },
    UI = {
        WindowPos = Vector2.new(100, 100),
        Open = true,
    }
}

local ConfigFile = "config.json"
function Settings:Load()
    local success, data = pcall(readfile, ConfigFile)
    if success and data then
        local decoded = game:GetService("HttpService"):JSONDecode(data)
        self.Combat = decoded.Combat or self.Combat
        self.Visuals = decoded.Visuals or self.Visuals
        self.Misc = decoded.Misc or self.Misc
        self.UI = decoded.UI or self.UI
    end
end

function Settings:Save()
    local data = game:GetService("HttpService"):JSONEncode({
        Combat = self.Combat,
        Visuals = self.Visuals,
        Misc = self.Misc,
        UI = self.UI
    })
    pcall(writefile, ConfigFile, data)
end

Settings:Load()

-- ============================================
-- UI Library (ScreenGui-based, Modern Stealth)
-- ============================================
local UI_Library = {}

function UI_Library:Init()
    -- Create ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "YoulterGUI"
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.DisplayOrder = 999 -- on top

    -- Main frame (glassmorphism + stroke)
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 500, 0, 400)
    mainFrame.Position = UDim2.new(0, Settings.UI.WindowPos.X, 0, Settings.UI.WindowPos.Y)
    mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15) -- #0F0F0F
    mainFrame.BackgroundTransparency = 0.1 -- 90% opaque (10% transparent)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    -- UICorner
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame

    -- UIStroke (glow effect)
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(0, 255, 136)
    stroke.Thickness = 1
    stroke.Transparency = 0.5
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    stroke.Parent = mainFrame

    -- Title bar (draggable)
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(0, 255, 136)
    titleBar.BackgroundTransparency = 0.2
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame

    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 8)
    titleCorner.Parent = titleBar

    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(1, -10, 1, 0)
    titleText.Position = UDim2.new(0, 10, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = "[INSERT GAME NAME] | Youlter_GPT"
    titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Font = Enum.Font.GothamBold
    titleText.TextSize = 16
    titleText.Parent = titleBar

    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 30, 1, 0)
    closeBtn.Position = UDim2.new(1, -30, 0, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    closeBtn.BackgroundTransparency = 0.5
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1,1,1)
    closeBtn.TextSize = 16
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = titleBar

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 4)
    closeCorner.Parent = closeBtn

    -- Tabs container
    local tabContainer = Instance.new("Frame")
    tabContainer.Name = "Tabs"
    tabContainer.Size = UDim2.new(1, 0, 0, 40)
    tabContainer.Position = UDim2.new(0, 0, 0, 30)
    tabContainer.BackgroundTransparency = 1
    tabContainer.Parent = mainFrame

    local tabLayout = Instance.new("UIListLayout")
    tabLayout.FillDirection = Enum.FillDirection.Horizontal
    tabLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tabLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    tabLayout.Padding = UDim.new(0, 10)
    tabLayout.Parent = tabContainer

    -- Content frame
    local contentFrame = Instance.new("Frame")
    contentFrame.Name = "Content"
    contentFrame.Size = UDim2.new(1, -20, 1, -90)
    contentFrame.Position = UDim2.new(0, 10, 0, 80)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Parent = mainFrame

    -- Store references
    self.ScreenGui = screenGui
    self.MainFrame = mainFrame
    self.ContentFrame = contentFrame
    self.Tabs = {}
    self.CloseBtn = closeBtn

    -- Dragging logic
    local dragging = false
    local dragOffset = Vector2.new(0, 0)
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragOffset = Vector2.new(Mouse.X, Mouse.Y) - Vector2.new(mainFrame.AbsolutePosition.X, mainFrame.AbsolutePosition.Y)
        end
    end)
    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local newPos = Vector2.new(Mouse.X, Mouse.Y) - dragOffset
            mainFrame.Position = UDim2.new(0, newPos.X, 0, newPos.Y)
            Settings.UI.WindowPos = newPos
        end
    end)

    -- Close button action
    closeBtn.MouseButton1Click:Connect(function()
        self:Close()
    end)

    -- Open animation (fade-in + scale)
    mainFrame.Scale = Vector3.new(0.8, 0.8, 0.8)
    mainFrame.BackgroundTransparency = 1
    TweenService:Create(mainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
        BackgroundTransparency = 0.1,
        Scale = Vector3.new(1, 1, 1)
    }):Play()

    return self
end

function UI_Library:Close()
    -- Animate close and then destroy
    TweenService:Create(self.MainFrame, TweenInfo.new(0.2), {
        BackgroundTransparency = 1,
        Scale = Vector3.new(0.8, 0.8, 0.8)
    }):Play()
    task.wait(0.2)
    self.ScreenGui:Destroy()
    Settings.UI.Open = false
    UserInputService.ModalEnabled = false -- release input block
end

function UI_Library:CreateTab(name)
    local tabBtn = Instance.new("TextButton")
    tabBtn.Name = name.."Tab"
    tabBtn.Size = UDim2.new(0, 100, 0, 30)
    tabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    tabBtn.Text = name
    tabBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    tabBtn.Font = Enum.Font.Gotham
    tabBtn.TextSize = 14
    tabBtn.Parent = self.Tabs.Container or (function() -- find tabContainer
        for _, child in ipairs(self.MainFrame:GetChildren()) do
            if child.Name == "Tabs" then return child end
        end
    end)()
    -- Rounded corners
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = tabBtn
    -- Hover animation
    tabBtn.MouseEnter:Connect(function()
        TweenService:Create(tabBtn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(0, 255, 136)}):Play()
    end)
    tabBtn.MouseLeave:Connect(function()
        TweenService:Create(tabBtn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(30, 30, 30)}):Play()
    end)

    return tabBtn
end

function UI_Library:CreateToggle(parent, text, getter, setter)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 30)
    frame.BackgroundTransparency = 1
    frame.Parent = parent

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 150, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.new(1,1,1)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.Parent = frame

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Size = UDim2.new(0, 20, 0, 20)
    toggleBtn.Position = UDim2.new(1, -30, 0.5, -10)
    toggleBtn.BackgroundColor3 = getter() and Color3.fromRGB(0, 255, 136) or Color3.fromRGB(80, 80, 80)
    toggleBtn.Text = ""
    toggleBtn.Parent = frame

    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 4)
    toggleCorner.Parent = toggleBtn

    toggleBtn.MouseButton1Click:Connect(function()
        local newVal = not getter()
        setter(newVal)
        toggleBtn.BackgroundColor3 = newVal and Color3.fromRGB(0, 255, 136) or Color3.fromRGB(80, 80, 80)
    end)

    return frame
end

function UI_Library:CreateSlider(parent, text, min, max, getter, setter)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 40)
    frame.BackgroundTransparency = 1
    frame.Parent = parent

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -50, 0, 20)
    label.BackgroundTransparency = 1
    label.Text = text .. ": " .. getter()
    label.TextColor3 = Color3.new(1,1,1)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.Parent = frame

    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(1, -20, 0, 4)
    sliderBg.Position = UDim2.new(0, 10, 0, 25)
    sliderBg.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    sliderBg.BorderSizePixel = 0
    sliderBg.Parent = frame

    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new((getter() - min) / (max - min), 0, 1, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 255, 136)
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBg

    local sliderButton = Instance.new("TextButton")
    sliderButton.Size = UDim2.new(0, 10, 0, 10)
    sliderButton.Position = UDim2.new((getter() - min) / (max - min), -5, 0.5, -5)
    sliderButton.BackgroundColor3 = Color3.fromRGB(0, 255, 136)
    sliderButton.Text = ""
    sliderButton.Parent = sliderBg

    local dragging = false
    sliderButton.MouseButton1Down:Connect(function()
        dragging = true
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local absPos = sliderBg.AbsolutePosition
            local absSize = sliderBg.AbsoluteSize.X
            local mouseX = Mouse.X
            local rel = math.clamp((mouseX - absPos.X) / absSize, 0, 1)
            local newVal = min + rel * (max - min)
            setter(math.floor(newVal))
            label.Text = text .. ": " .. getter()
            sliderFill.Size = UDim2.new(rel, 0, 1, 0)
            sliderButton.Position = UDim2.new(rel, -5, 0.5, -5)
        end
    end)
end

function UI_Library:CreateDropdown(parent, text, options, getter, setter)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 30)
    frame.BackgroundTransparency = 1
    frame.Parent = parent

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 150, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.new(1,1,1)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.Parent = frame

    local dropdownBtn = Instance.new("TextButton")
    dropdownBtn.Size = UDim2.new(0, 100, 0, 20)
    dropdownBtn.Position = UDim2.new(1, -110, 0.5, -10)
    dropdownBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    dropdownBtn.Text = getter()
    dropdownBtn.TextColor3 = Color3.new(1,1,1)
    dropdownBtn.Font = Enum.Font.Gotham
    dropdownBtn.TextSize = 12
    dropdownBtn.Parent = frame

    local dropCorner = Instance.new("UICorner")
    dropCorner.CornerRadius = UDim.new(0, 4)
    dropCorner.Parent = dropdownBtn

    local dropdownMenu = Instance.new("Frame")
    dropdownMenu.Size = UDim2.new(0, 100, 0, #options * 20)
    dropdownMenu.Position = UDim2.new(1, -110, 1, 5)
    dropdownMenu.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    dropdownMenu.Visible = false
    dropdownMenu.Parent = frame

    local menuCorner = Instance.new("UICorner")
    menuCorner.CornerRadius = UDim.new(0, 4)
    menuCorner.Parent = dropdownMenu

    local layout = Instance.new("UIListLayout")
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 2)
    layout.Parent = dropdownMenu

    for _, opt in ipairs(options) do
        local optBtn = Instance.new("TextButton")
        optBtn.Size = UDim2.new(1, 0, 0, 20)
        optBtn.BackgroundTransparency = 1
        optBtn.Text = opt
        optBtn.TextColor3 = Color3.new(1,1,1)
        optBtn.Font = Enum.Font.Gotham
        optBtn.TextSize = 12
        optBtn.Parent = dropdownMenu
        optBtn.MouseButton1Click:Connect(function()
            setter(opt)
            dropdownBtn.Text = opt
            dropdownMenu.Visible = false
        end)
        optBtn.MouseEnter:Connect(function()
            optBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 136)
            optBtn.BackgroundTransparency = 0.3
        end)
        optBtn.MouseLeave:Connect(function()
            optBtn.BackgroundTransparency = 1
        end)
    end

    dropdownBtn.MouseButton1Click:Connect(function()
        dropdownMenu.Visible = not dropdownMenu.Visible
    end)

    -- Close menu when clicking elsewhere (simplified)
    UserInputService.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local obj = input.Target
            if not dropdownMenu:IsAncestorOf(obj) and obj ~= dropdownBtn then
                dropdownMenu.Visible = false
            end
        end
    end)
end

function UI_Library:CreateButton(parent, text, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 120, 0, 30)
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    btn.Parent = parent

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 4)
    btnCorner.Parent = btn

    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(0, 255, 136)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(30, 30, 30)}):Play()
    end)

    btn.MouseButton1Click:Connect(callback)
end

-- ============================================
-- Build UI
-- ============================================
local UI = UI_Library:Init()
UserInputService.ModalEnabled = true -- block game input while menu open

-- Tabs
local combatTab = UI:CreateTab("Combat")
local visualsTab = UI:CreateTab("Visuals")
local settingsTab = UI:CreateTab("Settings")
local creditsTab = UI:CreateTab("Credits")

-- Content frames for each tab
local combatContent = Instance.new("Frame")
combatContent.Size = UDim2.new(1, 0, 1, 0)
combatContent.BackgroundTransparency = 1
combatContent.Visible = true
combatContent.Parent = UI.ContentFrame

local visualsContent = Instance.new("Frame")
visualsContent.Size = UDim2.new(1, 0, 1, 0)
visualsContent.BackgroundTransparency = 1
visualsContent.Visible = false
visualsContent.Parent = UI.ContentFrame

local settingsContent = Instance.new("Frame")
settingsContent.Size = UDim2.new(1, 0, 1, 0)
settingsContent.BackgroundTransparency = 1
settingsContent.Visible = false
settingsContent.Parent = UI.ContentFrame

local creditsContent = Instance.new("Frame")
creditsContent.Size = UDim2.new(1, 0, 1, 0)
creditsContent.BackgroundTransparency = 1
creditsContent.Visible = false
creditsContent.Parent = UI.ContentFrame

-- Tab switching
local function switchTab(tab)
    combatContent.Visible = (tab == "Combat")
    visualsContent.Visible = (tab == "Visuals")
    settingsContent.Visible = (tab == "Settings")
    creditsContent.Visible = (tab == "Credits")
end

combatTab.MouseButton1Click:Connect(function() switchTab("Combat") end)
visualsTab.MouseButton1Click:Connect(function() switchTab("Visuals") end)
settingsTab.MouseButton1Click:Connect(function() switchTab("Settings") end)
creditsTab.MouseButton1Click:Connect(function() switchTab("Credits") end)

-- Populate Combat tab
UI:CreateToggle(combatContent, "pSilent Aim", function() return Settings.Combat.pSilentEnabled end, function(v) Settings.Combat.pSilentEnabled = v end)
UI:CreateSlider(combatContent, "FOV", 30, 300, function() return Settings.Combat.FOV end, function(v) Settings.Combat.FOV = v end)
UI:CreateDropdown(combatContent, "Hitbox", {"Head", "Torso", "Random"}, function() return Settings.Combat.Hitbox end, function(v) Settings.Combat.Hitbox = v end)
UI:CreateToggle(combatContent, "Show FOV Circle", function() return Settings.Combat.ShowFOV end, function(v) Settings.Combat.ShowFOV = v end)

-- Populate Visuals tab
UI:CreateToggle(visualsContent, "Box ESP", function() return Settings.Visuals.BoxESP end, function(v) Settings.Visuals.BoxESP = v end)
UI:CreateToggle(visualsContent, "Tracer", function() return Settings.Visuals.Tracer end, function(v) Settings.Visuals.Tracer = v end)
UI:CreateToggle(visualsContent, "Health Bar", function() return Settings.Visuals.HealthBar end, function(v) Settings.Visuals.HealthBar = v end)
UI:CreateToggle(visualsContent, "Skeleton", function() return Settings.Visuals.Skeleton end, function(v) Settings.Visuals.Skeleton = v end)

-- Populate Settings tab
UI:CreateToggle(settingsContent, "Safe Mode", function() return Settings.Misc.SafeMode end, function(v) Settings.Misc.SafeMode = v end)
UI:CreateButton(settingsContent, "Save Config", function() Settings:Save() end)
UI:CreateButton(settingsContent, "Load Config", function() Settings:Load() end)

-- Populate Credits tab
local creditsLabel = Instance.new("TextLabel")
creditsLabel.Size = UDim2.new(1, 0, 1, 0)
creditsLabel.BackgroundTransparency = 1
creditsLabel.Text = "Youlter_GPT Framework\nCreated for [INSERT GAME NAME]\nDesign: Modern Dark Stealth\nFeatures: pSilent Aim, ESP, Config\nTween Animations\nEnjoy."
creditsLabel.TextColor3 = Color3.new(1,1,1)
creditsLabel.TextYAlignment = Enum.TextYAlignment.Top
creditsLabel.Font = Enum.Font.Gotham
creditsLabel.TextSize = 14
creditsLabel.Parent = creditsContent

-- ============================================
-- Visuals Module (Drawing-based ESP)
-- ============================================
local Visuals = {}

-- Persistent drawings per player
local espDrawings = {}

function Visuals:Update()
    if not Drawing then return end

    -- Clean up disconnected players
    for player, drawings in pairs(espDrawings) do
        if not player or not player.Parent then
            for _, d in pairs(drawings) do
                pcall(function() d:Remove() end)
            end
            espDrawings[player] = nil
        end
    end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
            local char = player.Character
            local humanoid = char.Humanoid
            local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
            if not root then continue end

            local pos, onScreen = self:WorldToScreen(root.Position)
            if not onScreen then
                -- Hide drawings for this player if off-screen
                if espDrawings[player] then
                    for _, d in pairs(espDrawings[player]) do
                        d.Visible = false
                    end
                end
                continue
            end

            -- Create drawings if not exist
            if not espDrawings[player] then
                espDrawings[player] = {}
                local tbl = espDrawings[player]

                -- Box corners (8 lines)
                for i = 1, 8 do
                    local line = Drawing.new("Line")
                    line.Thickness = Settings.Visuals.BoxThickness
                    line.Color = Settings.Visuals.BoxColor
                    line.Visible = false
                    table.insert(tbl, line)
                end

                -- Tracer line
                local tracer = Drawing.new("Line")
                tracer.Thickness = 1
                tracer.Color = Settings.Visuals.TracerColor
                tracer.Visible = false
                table.insert(tbl, tracer)

                -- Health bar background and fill
                local healthBg = Drawing.new("Square")
                healthBg.Filled = true
                healthBg.Color = Color3.new(0,0,0)
                healthBg.Visible = false
                table.insert(tbl, healthBg)

                local healthFill = Drawing.new("Square")
                healthFill.Filled = true
                healthFill.Visible = false
                table.insert(tbl, healthFill)

                -- Skeleton lines (up to 15 joints)
                for i = 1, 15 do
                    local line = Drawing.new("Line")
                    line.Thickness = 1
                    line.Color = Settings.Visuals.SkeletonColor
                    line.Visible = false
                    table.insert(tbl, line)
                end
            end

            local drawings = espDrawings[player]
            local index = 1

            -- Calculate box dimensions
            local head = char:FindFirstChild("Head")
            local headPos, headOnScreen = head and self:WorldToScreen(head.Position) or nil
            if not headOnScreen then headPos = pos + Vector2.new(0, -30) end

            local height = (headPos - pos).Magnitude * 2.5
            local width = height * 0.6
            local boxTopLeft = pos - Vector2.new(width/2, 0)
            local boxBottomRight = pos + Vector2.new(width/2, height)

            -- Update Box ESP
            if Settings.Visuals.BoxESP then
                local thickness = Settings.Visuals.BoxThickness
                local cornerLen = 5
                local color = Settings.Visuals.BoxColor

                -- Top left corner
                drawings[index].From = boxTopLeft
                drawings[index].To = boxTopLeft + Vector2.new(cornerLen, 0)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1

                drawings[index].From = boxTopLeft
                drawings[index].To = boxTopLeft + Vector2.new(0, cornerLen)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1

                -- Top right
                local tr = Vector2.new(boxBottomRight.X, boxTopLeft.Y)
                drawings[index].From = tr
                drawings[index].To = tr - Vector2.new(cornerLen, 0)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1

                drawings[index].From = tr
                drawings[index].To = tr + Vector2.new(0, cornerLen)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1

                -- Bottom left
                local bl = Vector2.new(boxTopLeft.X, boxBottomRight.Y)
                drawings[index].From = bl
                drawings[index].To = bl + Vector2.new(cornerLen, 0)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1

                drawings[index].From = bl
                drawings[index].To = bl - Vector2.new(0, cornerLen)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1

                -- Bottom right
                local br = boxBottomRight
                drawings[index].From = br
                drawings[index].To = br - Vector2.new(cornerLen, 0)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1

                drawings[index].From = br
                drawings[index].To = br - Vector2.new(0, cornerLen)
                drawings[index].Color = color
                drawings[index].Thickness = thickness
                drawings[index].Visible = true
                index = index + 1
            else
                -- Hide box lines
                for i = 1, 8 do
                    drawings[index].Visible = false
                    index = index + 1
                end
            end

            -- Update Tracer
            if Settings.Visuals.Tracer then
                drawings[index].From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                drawings[index].To = pos
                drawings[index].Color = Settings.Visuals.TracerColor
                drawings[index].Visible = true
                index = index + 1
            else
                drawings[index].Visible = false
                index = index + 1
            end

            -- Update Health Bar
            if Settings.Visuals.HealthBar then
                local healthPercent = humanoid.Health / humanoid.MaxHealth
                local barHeight = height
                local barWidth = 3
                local barPos = Vector2.new(boxTopLeft.X - barWidth - 2, boxTopLeft.Y)

                drawings[index].Size = Vector2.new(barWidth, barHeight)
                drawings[index].Position = barPos
                drawings[index].Visible = true
                index = index + 1

                drawings[index].Size = Vector2.new(barWidth, barHeight * healthPercent)
                drawings[index].Position = barPos + Vector2.new(0, barHeight * (1 - healthPercent))
                drawings[index].Color = Color3.new(1 - healthPercent, healthPercent, 0)
                drawings[index].Visible = true
                index = index + 1
            else
                drawings[index].Visible = false
                index = index + 1
                drawings[index].Visible = false
                index = index + 1
            end

            -- Update Skeleton
            if Settings.Visuals.Skeleton then
                local joints = {
                    {"Head", "UpperTorso"},
                    {"UpperTorso", "LowerTorso"},
                    {"UpperTorso", "LeftUpperArm"}, {"LeftUpperArm", "LeftLowerArm"}, {"LeftLowerArm", "LeftHand"},
                    {"UpperTorso", "RightUpperArm"}, {"RightUpperArm", "RightLowerArm"}, {"RightLowerArm", "RightHand"},
                    {"LowerTorso", "LeftUpperLeg"}, {"LeftUpperLeg", "LeftLowerLeg"}, {"LeftLowerLeg", "LeftFoot"},
                    {"LowerTorso", "RightUpperLeg"}, {"RightUpperLeg", "RightLowerLeg"}, {"RightLowerLeg", "RightFoot"},
                }
                for _, pair in ipairs(joints) do
                    local p1 = char:FindFirstChild(pair[1])
                    local p2 = char:FindFirstChild(pair[2])
                    if p1 and p2 then
                        local pos1, on1 = self:WorldToScreen(p1.Position)
                        local pos2, on2 = self:WorldToScreen(p2.Position)
                        if on1 and on2 then
                            drawings[index].From = pos1
                            drawings[index].To = pos2
                            drawings[index].Color = Settings.Visuals.SkeletonColor
                            drawings[index].Visible = true
                        else
                            drawings[index].Visible = false
                        end
                    else
                        drawings[index].Visible = false
                    end
                    index = index + 1
                end
            else
                -- Hide all skeleton lines (up to 15)
                for i = 1, 15 do
                    drawings[index].Visible = false
                    index = index + 1
                    if index > #drawings then break end
                end
            end
        end
    end
end

function Visuals:WorldToScreen(pos)
    local vec, onScreen = Camera:WorldToScreenPoint(pos)
    return Vector2.new(vec.X, vec.Y), onScreen
end

-- ============================================
-- Combat Module
-- ============================================
local Combat = {}

function Combat:Run()
    if not Settings.Combat.pSilentEnabled then return end
    if Settings.Misc.SafeMode then return end

    local target = self:GetClosestPlayerToMouse(Settings.Combat.FOV)
    if target then
        local hitPos = self:GetHitboxPosition(target, Settings.Combat.Hitbox)
        if hitPos then
            Mouse.Hit = CFrame.new(hitPos)
        end
    end
end

function Combat:GetClosestPlayerToMouse(fov)
    local mousePos = Vector2.new(Mouse.X, Mouse.Y)
    local closest = nil
    local shortestDist = fov or math.huge
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
            local head = player.Character:FindFirstChild("Head")
            if head then
                local screenPos, onScreen = Visuals:WorldToScreen(head.Position)
                if onScreen then
                    local dist = (mousePos - screenPos).Magnitude
                    if dist < shortestDist then
                        shortestDist = dist
                        closest = player
                    end
                end
            end
        end
    end
    return closest
end

function Combat:GetHitboxPosition(player, hitbox)
    if not player or not player.Character then return nil end
    local part
    if hitbox == "Head" then
        part = player.Character:FindFirstChild("Head")
    elseif hitbox == "Torso" then
        part = player.Character:FindFirstChild("Torso") or player.Character:FindFirstChild("UpperTorso")
    else -- Random
        local parts = {"Head", "Torso", "UpperTorso", "LowerTorso", "HumanoidRootPart"}
        for _, name in ipairs(parts) do
            part = player.Character:FindFirstChild(name)
            if part then break end
        end
    end
    return part and part.Position
end

-- Keybind
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Settings.Combat.pSilentKey then
        Combat:Run()
    end
end)

-- ============================================
-- Main Loop
-- ============================================
local fovCircle
if Drawing then
    fovCircle = Drawing.new("Circle")
    fovCircle.NumSides = 64
    fovCircle.Thickness = 1
    fovCircle.Filled = false
    fovCircle.Visible = false
end

RunService.RenderStepped:Connect(function()
    Visuals:Update()

    -- Update FOV circle
    if Drawing and fovCircle then
        if Settings.Combat.ShowFOV then
            fovCircle.Radius = Settings.Combat.FOV
            fovCircle.Position = Vector2.new(Mouse.X, Mouse.Y)
            fovCircle.Color = Settings.Combat.FOVColor
            fovCircle.Visible = true
        else
            fovCircle.Visible = false
        end
    end
end)

-- ============================================
-- Cleanup on close
-- ============================================
UI.CloseBtn.MouseButton1Click:Connect(function()
    if fovCircle then fovCircle:Remove() end
    for player, drawings in pairs(espDrawings) do
        for _, d in pairs(drawings) do
            pcall(function() d:Remove() end)
        end
    end
    espDrawings = {}
end)

print("[Youlter_GPT] Framework loaded with Modern Stealth UI")
