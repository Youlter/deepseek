--[[
    High-End Modular Script Framework (Fixed)
    Game: [INSERT GAME NAME]
    Fixes:
    - FOV circle now a single object that follows cursor.
    - UI is draggable and rendered on top of ESP.
    - UI redrawn each frame for proper layering.
]]

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Drawing library (if not supported, fallback to simple UI; assume executor has Drawing)
local Drawing = Drawing or nil
if not Drawing then
    warn("Drawing library not available â€“ ESP and UI will be disabled.")
end

-- ============================================
-- Module: Utils
-- ============================================
local Utils = {}

function Utils:WorldToScreen(pos)
    local vec, onScreen = Camera:WorldToScreenPoint(pos)
    return Vector2.new(vec.X, vec.Y), onScreen
end

function Utils:GetClosestPlayerToMouse(fov)
    local mousePos = Vector2.new(Mouse.X, Mouse.Y)
    local closest = nil
    local shortestDist = fov or math.huge
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
            local head = player.Character:FindFirstChild("Head")
            if head then
                local screenPos, onScreen = self:WorldToScreen(head.Position)
                if onScreen then
                    local dist = (mousePos - screenPos).Magnitude
                    if dist < shortestDist then
                        shortestDist = dist
                        closest = player
                    end
                end
            end
        end
    end
    return closest
end

function Utils:GetHitboxPosition(player, hitbox)
    if not player or not player.Character then return nil end
    local part
    if hitbox == "Head" then
        part = player.Character:FindFirstChild("Head")
    elseif hitbox == "Torso" then
        part = player.Character:FindFirstChild("Torso") or player.Character:FindFirstChild("UpperTorso")
    else -- Random
        local parts = {"Head", "Torso", "UpperTorso", "LowerTorso", "HumanoidRootPart"}
        for _, name in ipairs(parts) do
            part = player.Character:FindFirstChild(name)
            if part then break end
        end
    end
    return part and part.Position
end

-- ============================================
-- Module: Settings
-- ============================================
local Settings = {
    Combat = {
        pSilentEnabled = false,
        pSilentKey = Enum.KeyCode.Q,
        FOV = 90,
        Hitbox = "Head",
        ShowFOV = true,
        FOVColor = Color3.fromRGB(191, 64, 191),
    },
    Visuals = {
        BoxESP = true,
        BoxColor = Color3.fromRGB(255, 255, 255),
        BoxThickness = 1,
        Tracer = true,
        TracerColor = Color3.fromRGB(191, 64, 191),
        HealthBar = true,
        Skeleton = false,
        SkeletonColor = Color3.fromRGB(255, 255, 255),
    },
    Misc = {
        SafeMode = false,
    },
    UI = {
        WindowPos = Vector2.new(100, 100), -- initial position
    }
}

local ConfigFile = "config.json"
function Settings:Load()
    local success, data = pcall(readfile, ConfigFile)
    if success and data then
        local decoded = game:GetService("HttpService"):JSONDecode(data)
        self.Combat = decoded.Combat or self.Combat
        self.Visuals = decoded.Visuals or self.Visuals
        self.Misc = decoded.Misc or self.Misc
        self.UI = decoded.UI or self.UI
    end
end

function Settings:Save()
    local data = game:GetService("HttpService"):JSONEncode({
        Combat = self.Combat,
        Visuals = self.Visuals,
        Misc = self.Misc,
        UI = self.UI
    })
    pcall(writefile, ConfigFile, data)
end

Settings:Load()

-- ============================================
-- Module: UI (Recreated each frame for proper layering)
-- ============================================
local UI = {
    activeTab = "Combat",
    dragging = false,
    dragOffset = Vector2.new(0, 0),
    windowSize = Vector2.new(500, 400),
}

-- Function to draw the entire UI each frame
function UI:Draw()
    if not Drawing then return end

    local winPos = Settings.UI.WindowPos
    local winSize = self.windowSize

    -- Draw background (glassmorphism)
    local bg = Drawing.new("Square")
    bg.Size = winSize
    bg.Position = winPos
    bg.Color = Color3.fromRGB(18, 18, 18) -- Deep Charcoal
    bg.Transparency = 0.2
    bg.Filled = true
    bg.Visible = true
    -- Store in temporary table? We'll just let them be garbage collected after frame? Actually we need to keep them visible for the frame.
    -- Since we're drawing each frame, we need to ensure they are drawn immediately. But Drawing objects persist until removed.
    -- To avoid accumulation, we should remove previous frame's UI drawings. We'll use a table to store current frame's drawings and remove them at the beginning of next frame.
    -- Better: create all UI drawings, then at the end of the frame they will remain. To remove them, we need to store them and remove next frame.
    -- We'll use a simple approach: keep a global list `uiDrawings` and clear it each frame before redrawing.
    if not _G.uiDrawings then _G.uiDrawings = {} end
    -- Remove old drawings
    for _, obj in ipairs(_G.uiDrawings) do
        pcall(function() obj:Remove() end)
    end
    _G.uiDrawings = {}

    -- Helper to add a drawing to the list
    local function addDrawing(d)
        table.insert(_G.uiDrawings, d)
        return d
    end

    -- Background
    addDrawing(bg)

    -- Title bar (draggable area)
    local titleBar = Drawing.new("Square")
    titleBar.Size = Vector2.new(winSize.X, 30)
    titleBar.Position = winPos
    titleBar.Color = Color3.fromRGB(191, 64, 191)
    titleBar.Transparency = 0.5
    titleBar.Filled = true
    titleBar.Visible = true
    addDrawing(titleBar)

    -- Title text
    local titleText = Drawing.new("Text")
    titleText.Text = "[INSERT GAME NAME] | Youlter_GPT"
    titleText.Color = Color3.new(1,1,1)
    titleText.Position = winPos + Vector2.new(10, 5)
    titleText.Size = 18
    titleText.Center = false
    titleText.Outline = true
    titleText.Visible = true
    addDrawing(titleText)

    -- Tabs
    local tabs = {"Combat", "Visuals", "Settings", "Credits"}
    for i, name in ipairs(tabs) do
        local tabX = winPos.X + (i-1) * 125
        local tabY = winPos.Y + 30

        local tabBg = Drawing.new("Square")
        tabBg.Size = Vector2.new(125, 30)
        tabBg.Position = Vector2.new(tabX, tabY)
        tabBg.Color = (self.activeTab == name) and Color3.fromRGB(191, 64, 191) or Color3.fromRGB(80, 80, 80)
        tabBg.Transparency = 0.7
        tabBg.Filled = true
        tabBg.Visible = true
        addDrawing(tabBg)

        local tabText = Drawing.new("Text")
        tabText.Text = name
        tabText.Color = Color3.new(1,1,1)
        tabText.Position = Vector2.new(tabX + 62, tabY + 7)
        tabText.Size = 16
        tabText.Center = true
        tabText.Visible = true
        addDrawing(tabText)
    end

    -- Content background
    local contentBg = Drawing.new("Square")
    contentBg.Size = Vector2.new(winSize.X, winSize.Y - 60)
    contentBg.Position = winPos + Vector2.new(0, 60)
    contentBg.Color = Color3.fromRGB(18, 18, 18)
    contentBg.Transparency = 0.3
    contentBg.Filled = true
    contentBg.Visible = true
    addDrawing(contentBg)

    -- Draw tab-specific content
    if self.activeTab == "Combat" then
        -- pSilent toggle
        local toggleBg = Drawing.new("Square")
        toggleBg.Size = Vector2.new(20,20)
        toggleBg.Position = winPos + Vector2.new(20, 80)
        toggleBg.Color = Settings.Combat.pSilentEnabled and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        toggleBg.Filled = true
        toggleBg.Visible = true
        addDrawing(toggleBg)

        local toggleText = Drawing.new("Text")
        toggleText.Text = "pSilent Aim"
        toggleText.Color = Color3.new(1,1,1)
        toggleText.Position = winPos + Vector2.new(50, 80)
        toggleText.Size = 14
        toggleText.Visible = true
        addDrawing(toggleText)

        -- FOV slider (simulated with text)
        local fovText = Drawing.new("Text")
        fovText.Text = "FOV: " .. Settings.Combat.FOV
        fovText.Color = Color3.new(1,1,1)
        fovText.Position = winPos + Vector2.new(20, 110)
        fovText.Size = 14
        fovText.Visible = true
        addDrawing(fovText)

        -- Hitbox display
        local hitboxText = Drawing.new("Text")
        hitboxText.Text = "Hitbox: " .. Settings.Combat.Hitbox
        hitboxText.Color = Color3.new(1,1,1)
        hitboxText.Position = winPos + Vector2.new(20, 140)
        hitboxText.Size = 14
        hitboxText.Visible = true
        addDrawing(hitboxText)

        -- Show FOV toggle
        local fovCircleBg = Drawing.new("Square")
        fovCircleBg.Size = Vector2.new(20,20)
        fovCircleBg.Position = winPos + Vector2.new(20, 170)
        fovCircleBg.Color = Settings.Combat.ShowFOV and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        fovCircleBg.Filled = true
        fovCircleBg.Visible = true
        addDrawing(fovCircleBg)

        local fovCircleText = Drawing.new("Text")
        fovCircleText.Text = "Show FOV Circle"
        fovCircleText.Color = Color3.new(1,1,1)
        fovCircleText.Position = winPos + Vector2.new(50, 170)
        fovCircleText.Size = 14
        fovCircleText.Visible = true
        addDrawing(fovCircleText)

    elseif self.activeTab == "Visuals" then
        -- Box ESP toggle
        local boxBg = Drawing.new("Square")
        boxBg.Size = Vector2.new(20,20)
        boxBg.Position = winPos + Vector2.new(20, 80)
        boxBg.Color = Settings.Visuals.BoxESP and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        boxBg.Filled = true
        boxBg.Visible = true
        addDrawing(boxBg)

        local boxText = Drawing.new("Text")
        boxText.Text = "Box ESP"
        boxText.Color = Color3.new(1,1,1)
        boxText.Position = winPos + Vector2.new(50, 80)
        boxText.Size = 14
        boxText.Visible = true
        addDrawing(boxText)

        -- Tracer toggle
        local tracerBg = Drawing.new("Square")
        tracerBg.Size = Vector2.new(20,20)
        tracerBg.Position = winPos + Vector2.new(20, 110)
        tracerBg.Color = Settings.Visuals.Tracer and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        tracerBg.Filled = true
        tracerBg.Visible = true
        addDrawing(tracerBg)

        local tracerText = Drawing.new("Text")
        tracerText.Text = "Tracer"
        tracerText.Color = Color3.new(1,1,1)
        tracerText.Position = winPos + Vector2.new(50, 110)
        tracerText.Size = 14
        tracerText.Visible = true
        addDrawing(tracerText)

        -- Health Bar toggle
        local healthBg = Drawing.new("Square")
        healthBg.Size = Vector2.new(20,20)
        healthBg.Position = winPos + Vector2.new(20, 140)
        healthBg.Color = Settings.Visuals.HealthBar and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        healthBg.Filled = true
        healthBg.Visible = true
        addDrawing(healthBg)

        local healthText = Drawing.new("Text")
        healthText.Text = "Health Bar"
        healthText.Color = Color3.new(1,1,1)
        healthText.Position = winPos + Vector2.new(50, 140)
        healthText.Size = 14
        healthText.Visible = true
        addDrawing(healthText)

        -- Skeleton toggle
        local skelBg = Drawing.new("Square")
        skelBg.Size = Vector2.new(20,20)
        skelBg.Position = winPos + Vector2.new(20, 170)
        skelBg.Color = Settings.Visuals.Skeleton and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        skelBg.Filled = true
        skelBg.Visible = true
        addDrawing(skelBg)

        local skelText = Drawing.new("Text")
        skelText.Text = "Skeleton ESP"
        skelText.Color = Color3.new(1,1,1)
        skelText.Position = winPos + Vector2.new(50, 170)
        skelText.Size = 14
        skelText.Visible = true
        addDrawing(skelText)

    elseif self.activeTab == "Settings" then
        -- Safe mode toggle
        local safeBg = Drawing.new("Square")
        safeBg.Size = Vector2.new(20,20)
        safeBg.Position = winPos + Vector2.new(20, 80)
        safeBg.Color = Settings.Misc.SafeMode and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        safeBg.Filled = true
        safeBg.Visible = true
        addDrawing(safeBg)

        local safeText = Drawing.new("Text")
        safeText.Text = "Safe Mode"
        safeText.Color = Color3.new(1,1,1)
        safeText.Position = winPos + Vector2.new(50, 80)
        safeText.Size = 14
        safeText.Visible = true
        addDrawing(safeText)

        -- Save config button
        local saveText = Drawing.new("Text")
        saveText.Text = "Save Config"
        saveText.Color = Color3.fromRGB(191, 64, 191)
        saveText.Position = winPos + Vector2.new(20, 120)
        saveText.Size = 16
        saveText.Visible = true
        addDrawing(saveText)

        -- Load config button
        local loadText = Drawing.new("Text")
        loadText.Text = "Load Config"
        loadText.Color = Color3.fromRGB(191, 64, 191)
        loadText.Position = winPos + Vector2.new(20, 150)
        loadText.Size = 16
        loadText.Visible = true
        addDrawing(loadText)

    elseif self.activeTab == "Credits" then
        local creditText = Drawing.new("Text")
        creditText.Text = "Youlter_GPT Framework\nCreated for [INSERT GAME NAME]\nDesign: Glassmorphism\nFeatures: pSilent Aim, ESP, Config\nEnjoy."
        creditText.Color = Color3.new(1,1,1)
        creditText.Position = winPos + Vector2.new(20, 80)
        creditText.Size = 14
        creditText.Visible = true
        addDrawing(creditText)
    end
end

-- Input handling for UI interactions (tabs, toggles, dragging)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mousePos = Vector2.new(Mouse.X, Mouse.Y)
        local winPos = Settings.UI.WindowPos
        local winSize = UI.windowSize

        -- Check if clicked on title bar (for dragging)
        if mousePos.X >= winPos.X and mousePos.X <= winPos.X + winSize.X and
           mousePos.Y >= winPos.Y and mousePos.Y <= winPos.Y + 30 then
            UI.dragging = true
            UI.dragOffset = mousePos - winPos
        end

        -- Check tab clicks (using current winPos)
        for i, name in ipairs({"Combat", "Visuals", "Settings", "Credits"}) do
            local tabX = winPos.X + (i-1) * 125
            local tabY = winPos.Y + 30
            if mousePos.X >= tabX and mousePos.X <= tabX + 125 and
               mousePos.Y >= tabY and mousePos.Y <= tabY + 30 then
                UI.activeTab = name
                break
            end
        end

        -- Check content area clicks based on active tab
        if UI.activeTab == "Combat" then
            -- pSilent toggle
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 40 and
               mousePos.Y >= winPos.Y + 80 and mousePos.Y <= winPos.Y + 100 then
                Settings.Combat.pSilentEnabled = not Settings.Combat.pSilentEnabled
            end
            -- Show FOV toggle
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 40 and
               mousePos.Y >= winPos.Y + 170 and mousePos.Y <= winPos.Y + 190 then
                Settings.Combat.ShowFOV = not Settings.Combat.ShowFOV
            end
            -- Hitbox cycle (click on text area)
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 200 and
               mousePos.Y >= winPos.Y + 140 and mousePos.Y <= winPos.Y + 160 then
                local opts = {"Head", "Torso", "Random"}
                local idx = 1
                for i, v in ipairs(opts) do if v == Settings.Combat.Hitbox then idx = i+1 end end
                Settings.Combat.Hitbox = opts[(idx-1)%3+1]
            end
            -- FOV slider (click on text area to adjust)
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 280 and
               mousePos.Y >= winPos.Y + 110 and mousePos.Y <= winPos.Y + 130 then
                local rel = (mousePos.X - (winPos.X + 20)) / 260
                Settings.Combat.FOV = math.floor(30 + rel * 200)
            end
        elseif UI.activeTab == "Visuals" then
            -- Box ESP
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 40 and
               mousePos.Y >= winPos.Y + 80 and mousePos.Y <= winPos.Y + 100 then
                Settings.Visuals.BoxESP = not Settings.Visuals.BoxESP
            end
            -- Tracer
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 40 and
               mousePos.Y >= winPos.Y + 110 and mousePos.Y <= winPos.Y + 130 then
                Settings.Visuals.Tracer = not Settings.Visuals.Tracer
            end
            -- Health Bar
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 40 and
               mousePos.Y >= winPos.Y + 140 and mousePos.Y <= winPos.Y + 160 then
                Settings.Visuals.HealthBar = not Settings.Visuals.HealthBar
            end
            -- Skeleton
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 40 and
               mousePos.Y >= winPos.Y + 170 and mousePos.Y <= winPos.Y + 190 then
                Settings.Visuals.Skeleton = not Settings.Visuals.Skeleton
            end
        elseif UI.activeTab == "Settings" then
            -- Safe mode
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 40 and
               mousePos.Y >= winPos.Y + 80 and mousePos.Y <= winPos.Y + 100 then
                Settings.Misc.SafeMode = not Settings.Misc.SafeMode
            end
            -- Save config
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 120 and
               mousePos.Y >= winPos.Y + 120 and mousePos.Y <= winPos.Y + 140 then
                Settings:Save()
            end
            -- Load config
            if mousePos.X >= winPos.X + 20 and mousePos.X <= winPos.X + 120 and
               mousePos.Y >= winPos.Y + 150 and mousePos.Y <= winPos.Y + 170 then
                Settings:Load()
            end
        end
    end
end)

UserInputService.InputChanged:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseMovement and UI.dragging then
        local mousePos = Vector2.new(Mouse.X, Mouse.Y)
        Settings.UI.WindowPos = mousePos - UI.dragOffset
    end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        UI.dragging = false
    end
end)

-- ============================================
-- Module: Combat (pSilent Aim)
-- ============================================
local Combat = {}

function Combat:Run()
    if not Settings.Combat.pSilentEnabled then return end
    if Settings.Misc.SafeMode then return end

    local target = Utils:GetClosestPlayerToMouse(Settings.Combat.FOV)
    if target then
        local hitPos = Utils:GetHitboxPosition(target, Settings.Combat.Hitbox)
        if hitPos then
            -- pSilent: set mouse's target
            Mouse.Hit = CFrame.new(hitPos)
        end
    end
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Settings.Combat.pSilentKey then
        Combat:Run()
    end
end)

-- ============================================
-- Module: Visuals (ESP)
-- ============================================
local Visuals = {}

local espDrawings = {}

function Visuals:Update()
    if not Drawing then return end

    -- Clear previous ESP drawings
    for _, obj in ipairs(espDrawings) do
        pcall(function() obj:Remove() end)
    end
    espDrawings = {}

    if not Settings.Visuals.BoxESP and not Settings.Visuals.Tracer and not Settings.Visuals.HealthBar and not Settings.Visuals.Skeleton then
        return
    end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
            local char = player.Character
            local humanoid = char.Humanoid
            local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
            if not root then continue end

            local pos, onScreen = Utils:WorldToScreen(root.Position)
            if not onScreen then continue end

            -- Calculate box dimensions
            local head = char:FindFirstChild("Head")
            local headPos, headOnScreen = head and Utils:WorldToScreen(head.Position) or nil
            if not headOnScreen then headPos = pos + Vector2.new(0, -30) end

            local height = (headPos - pos).Magnitude * 2.5
            local width = height * 0.6
            local boxTopLeft = pos - Vector2.new(width/2, 0)
            local boxBottomRight = pos + Vector2.new(width/2, height)

            if Settings.Visuals.BoxESP then
                local thickness = Settings.Visuals.BoxThickness
                local cornerLen = 5
                local color = Settings.Visuals.BoxColor

                -- Top left corner
                local l1 = Drawing.new("Line")
                l1.From = boxTopLeft
                l1.To = boxTopLeft + Vector2.new(cornerLen, 0)
                l1.Color = color
                l1.Thickness = thickness
                l1.Visible = true
                table.insert(espDrawings, l1)

                local l2 = Drawing.new("Line")
                l2.From = boxTopLeft
                l2.To = boxTopLeft + Vector2.new(0, cornerLen)
                l2.Color = color
                l2.Thickness = thickness
                l2.Visible = true
                table.insert(espDrawings, l2)

                -- Top right
                local tr = Vector2.new(boxBottomRight.X, boxTopLeft.Y)
                local l3 = Drawing.new("Line")
                l3.From = tr
                l3.To = tr - Vector2.new(cornerLen, 0)
                l3.Color = color
                l3.Thickness = thickness
                l3.Visible = true
                table.insert(espDrawings, l3)

                local l4 = Drawing.new("Line")
                l4.From = tr
                l4.To = tr + Vector2.new(0, cornerLen)
                l4.Color = color
                l4.Thickness = thickness
                l4.Visible = true
                table.insert(espDrawings, l4)

                -- Bottom left
                local bl = Vector2.new(boxTopLeft.X, boxBottomRight.Y)
                local l5 = Drawing.new("Line")
                l5.From = bl
                l5.To = bl + Vector2.new(cornerLen, 0)
                l5.Color = color
                l5.Thickness = thickness
                l5.Visible = true
                table.insert(espDrawings, l5)

                local l6 = Drawing.new("Line")
                l6.From = bl
                l6.To = bl - Vector2.new(0, cornerLen)
                l6.Color = color
                l6.Thickness = thickness
                l6.Visible = true
                table.insert(espDrawings, l6)

                -- Bottom right
                local br = boxBottomRight
                local l7 = Drawing.new("Line")
                l7.From = br
                l7.To = br - Vector2.new(cornerLen, 0)
                l7.Color = color
                l7.Thickness = thickness
                l7.Visible = true
                table.insert(espDrawings, l7)

                local l8 = Drawing.new("Line")
                l8.From = br
                l8.To = br - Vector2.new(0, cornerLen)
                l8.Color = color
                l8.Thickness = thickness
                l8.Visible = true
                table.insert(espDrawings, l8)
            end

            if Settings.Visuals.Tracer then
                local tracer = Drawing.new("Line")
                tracer.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                tracer.To = pos
                tracer.Color = Settings.Visuals.TracerColor
                tracer.Thickness = 1
                tracer.Visible = true
                table.insert(espDrawings, tracer)
            end

            if Settings.Visuals.HealthBar then
                local healthPercent = humanoid.Health / humanoid.MaxHealth
                local barHeight = height
                local barWidth = 3
                local barPos = Vector2.new(boxTopLeft.X - barWidth - 2, boxTopLeft.Y)

                local bgBar = Drawing.new("Square")
                bgBar.Size = Vector2.new(barWidth, barHeight)
                bgBar.Position = barPos
                bgBar.Color = Color3.new(0,0,0)
                bgBar.Filled = true
                bgBar.Visible = true
                table.insert(espDrawings, bgBar)

                local fillBar = Drawing.new("Square")
                fillBar.Size = Vector2.new(barWidth, barHeight * healthPercent)
                fillBar.Position = barPos + Vector2.new(0, barHeight * (1 - healthPercent))
                fillBar.Color = Color3.new(1 - healthPercent, healthPercent, 0)
                fillBar.Filled = true
                fillBar.Visible = true
                table.insert(espDrawings, fillBar)
            end

            if Settings.Visuals.Skeleton and char:FindFirstChild("Head") and char:FindFirstChild("UpperTorso") then
                local joints = {
                    {"Head", "UpperTorso"},
                    {"UpperTorso", "LowerTorso"},
                    {"UpperTorso", "LeftUpperArm"}, {"LeftUpperArm", "LeftLowerArm"}, {"LeftLowerArm", "LeftHand"},
                    {"UpperTorso", "RightUpperArm"}, {"RightUpperArm", "RightLowerArm"}, {"RightLowerArm", "RightHand"},
                    {"LowerTorso", "LeftUpperLeg"}, {"LeftUpperLeg", "LeftLowerLeg"}, {"LeftLowerLeg", "LeftFoot"},
                    {"LowerTorso", "RightUpperLeg"}, {"RightUpperLeg", "RightLowerLeg"}, {"RightLowerLeg", "RightFoot"},
                }
                for _, pair in ipairs(joints) do
                    local p1 = char:FindFirstChild(pair[1])
                    local p2 = char:FindFirstChild(pair[2])
                    if p1 and p2 then
                        local pos1, on1 = Utils:WorldToScreen(p1.Position)
                        local pos2, on2 = Utils:WorldToScreen(p2.Position)
                        if on1 and on2 then
                            local line = Drawing.new("Line")
                            line.From = pos1
                            line.To = pos2
                            line.Color = Settings.Visuals.SkeletonColor
                            line.Thickness = 1
                            line.Visible = true
                            table.insert(espDrawings, line)
                        end
                    end
                end
            end
        end
    end
end

-- ============================================
-- Main Loop
-- ============================================
local fovCircle -- persistent FOV circle

RunService.RenderStepped:Connect(function()
    -- Update ESP first (creates new drawings)
    Visuals:Update()

    -- Update FOV circle (single object)
    if Drawing then
        if Settings.Combat.ShowFOV then
            if not fovCircle then
                fovCircle = Drawing.new("Circle")
                fovCircle.NumSides = 64
                fovCircle.Thickness = 1
                fovCircle.Filled = false
            end
            fovCircle.Radius = Settings.Combat.FOV
            fovCircle.Position = Vector2.new(Mouse.X, Mouse.Y)
            fovCircle.Color = Settings.Combat.FOVColor
            fovCircle.Visible = true
        elseif fovCircle then
            fovCircle.Visible = false
        end
    end

    -- Draw UI after ESP (so UI appears on top)
    UI:Draw()
end)

-- ============================================
-- Initialization
-- ============================================
print("[Youlter_GPT] Framework loaded for [INSERT GAME NAME] (Fixed version)")
